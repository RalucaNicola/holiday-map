var z=Object.defineProperty,W=Object.defineProperties;var K=Object.getOwnPropertyDescriptors;var M=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Y=Object.prototype.propertyIsEnumerable;var G=(t,e,r)=>e in t?z(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r,E=(t,e)=>{for(var r in e||(e={}))X.call(e,r)&&G(t,r,e[r]);if(M)for(var r of M(e))Y.call(e,r)&&G(t,r,e[r]);return t},U=(t,e)=>W(t,K(e));import{r as O,aL as ee,c9 as te,an as o,a as p,dP as re,cb as ie,cU as L,b4 as se,dQ as oe,n as F,cG as Q,dR as ae,cP as T,dS as ne,c5 as pe,dT as le,dG as ue,cO as me,dU as ye,dV as de,U as ce,d3 as he,C as A,w as fe,B as ge,cH as we,d8 as ve,s as xe,dq as be,M as $e,ae as q}from"./vendor.c414a8c9.js";import{t as Pe}from"./BitmapContainer.c9ff86ec.js";import{f as Ie,u as Se}from"./LayerView.da2fde64.js";import{a as Ee}from"./BaseGraphicContainer.1378f3d2.js";import{n as Ne}from"./HighlightGraphicContainer.caa9c2c2.js";import{S as Oe}from"./ExportStrategy.6c446032.js";import{r as je,i as Fe}from"./scaleUtils.edcb9e53.js";import{c as Re}from"./ExportImageParameters.8eae0ec5.js";import{n as _}from"./floorFilterUtils.69500d62.js";import{s as J,a as Ue}from"./drapedUtils.d46a7156.js";import{i as Ve}from"./sublayerUtils.b8a7a6d3.js";import{d as _e,s as Me}from"./popupUtils.79cbcb0c.js";import{i as Ge}from"./RefreshableLayerView.909741ab.js";import"./WGLContainer.400ca512.js";import"./enums.de935fa5.js";import"./pixelUtils.8244b2be.js";import"./utils.26cfa974.js";import"./Utils.d29fb889.js";import"./enums.6e42a319.js";import"./Texture.21608732.js";import"./VertexElementDescriptor.d386088d.js";import"./MaterialKey.003e1aef.js";import"./VertexArrayObject.6089921b.js";import"./ProgramTemplate.443da894.js";import"./StyleDefinition.627ffe6c.js";import"./config.40d47db8.js";import"./GeometryUtils.8166011b.js";import"./earcut.d30cbec0.js";import"./CIMSymbolHelper.cef2d21f.js";import"./BidiEngine.ec67919b.js";import"./GeometryUtils.814cb798.js";import"./normalizeUtilsSync.8b6bc9a0.js";import"./projectionSupport.441f613a.js";import"./json.d1a0fa35.js";import"./FeatureContainer.cde7992c.js";import"./TileContainer.985039f3.js";import"./visualVariablesUtils.65951d45.js";import"./visualVariablesUtils.f6ff214d.js";import"./Matcher.9dc9529f.js";import"./tileUtils.4ce20f65.js";import"./TileClipper.139cac50.js";import"./Geometry.b68345ae.js";import"./ExpandedCIM.13be576b.js";import"./quantizationUtils.2450b4c7.js";import"./devEnvironmentUtils.8c6e6b72.js";import"./schemaUtils.48f0e3c8.js";import"./createSymbolSchema.7c9fbeea.js";import"./MD5.97b39efc.js";import"./util.dfab6411.js";import"./ComputedAttributeStorage.1471d426.js";import"./centroid.0a864aab.js";import"./vec3f32.8d37ecf5.js";import"./Bitmap.95cbe132.js";const C=t=>t.spatialReference.wkid||JSON.stringify(t.spatialReference);function Ae(t,e){const{dpi:r,gdbVersion:s,geometry:i,geometryPrecision:n,height:m,layerOption:l,mapExtent:a,maxAllowableOffset:c,returnFieldName:y,returnGeometry:h,returnUnformattedValues:g,returnZ:I,spatialReference:$,timeExtent:P,tolerance:u,width:b}=t.toJSON(),{dynamicLayers:w,layerDefs:f,layerIds:v}=qe(t),R=e&&O(e.geometry)?e.geometry:null,x={geometryPrecision:n,maxAllowableOffset:c,returnFieldName:y,returnGeometry:h,returnUnformattedValues:g,returnZ:I,tolerance:u},N=R&&R.toJSON()||i;if(x.imageDisplay=`${b},${m},${r}`,s&&(x.gdbVersion=s),N&&(delete N.spatialReference,x.geometry=JSON.stringify(N),x.geometryType=ee(N)),$?x.sr=$.wkid||JSON.stringify($):N&&N.spatialReference?x.sr=C(N):a&&a.spatialReference&&(x.sr=C(a)),x.time=P?[P.start,P.end].join(","):null,a){const{xmin:B,ymin:k,xmax:Z,ymax:H}=a;x.mapExtent=`${B},${k},${Z},${H}`}return f&&(x.layerDefs=f),w&&!f&&(x.dynamicLayers=w),x.layers=l==="popup"?"visible":l,v&&!w&&(x.layers+=`:${v.join(",")}`),x}function qe(t){var $,P;const{mapExtent:e,floors:r,width:s,sublayers:i,layerIds:n,layerOption:m,gdbVersion:l}=t,a=(P=($=i==null?void 0:i.find(u=>u.layer!=null))==null?void 0:$.layer)==null?void 0:P.serviceSublayers,c=m==="popup",y={},h=je({extent:e,width:s,spatialReference:e==null?void 0:e.spatialReference}),g=[],I=u=>{const b=h===0,w=u.minScale===0||h<=u.minScale,f=u.maxScale===0||h>=u.maxScale;if(u.visible&&(b||w&&f))if(u.sublayers)u.sublayers.forEach(I);else{if((n==null?void 0:n.includes(u.id))===!1||c&&(!u.popupTemplate||!u.popupEnabled))return;g.unshift(u)}};if(i==null||i.forEach(I),i&&!g.length)y.layerIds=[];else{const u=Ve(g,a,l),b=g.map(w=>{const f=_(r,w);return w.toExportImageJSON(f)});if(u)y.dynamicLayers=JSON.stringify(b);else{if(i){let f=g.map(({id:v})=>v);n&&(f=f.filter(v=>n.includes(v))),y.layerIds=f}else(n==null?void 0:n.length)&&(y.layerIds=n);const w=Je(r,g);if(O(w)&&w.length){const f={};for(const v of w)v.definitionExpression&&(f[v.id]=v.definitionExpression);Object.keys(f).length&&(y.layerDefs=JSON.stringify(f))}}}return y}function Je(t,e){const r=!!(t==null?void 0:t.length),s=e.filter(i=>i.definitionExpression!=null||r&&i.floorInfo!=null);return s.length?s.map(i=>{const n=_(t,i),m=te(n,i.definitionExpression);return{id:i.id,definitionExpression:m}}):null}var V;let d=V=class extends Q{constructor(t){super(t),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}static from(t){return ae(V,t)}};o([p({type:Number,json:{write:!0}})],d.prototype,"dpi",void 0),o([p()],d.prototype,"floors",void 0),o([p({type:String,json:{write:!0}})],d.prototype,"gdbVersion",void 0),o([p({types:re,json:{read:ie,write:!0}})],d.prototype,"geometry",void 0),o([p({type:Number,json:{write:!0}})],d.prototype,"geometryPrecision",void 0),o([p({type:Number,json:{write:!0}})],d.prototype,"height",void 0),o([p({type:[Number],json:{write:!0}})],d.prototype,"layerIds",void 0),o([p({type:["top","visible","all","popup"],json:{write:!0}})],d.prototype,"layerOption",void 0),o([p({type:L,json:{write:!0}})],d.prototype,"mapExtent",void 0),o([p({type:Number,json:{write:!0}})],d.prototype,"maxAllowableOffset",void 0),o([p({type:Boolean,json:{write:!0}})],d.prototype,"returnFieldName",void 0),o([p({type:Boolean,json:{write:!0}})],d.prototype,"returnGeometry",void 0),o([p({type:Boolean,json:{write:!0}})],d.prototype,"returnM",void 0),o([p({type:Boolean,json:{write:!0}})],d.prototype,"returnUnformattedValues",void 0),o([p({type:Boolean,json:{write:!0}})],d.prototype,"returnZ",void 0),o([p({type:se,json:{write:!0}})],d.prototype,"spatialReference",void 0),o([p()],d.prototype,"sublayers",void 0),o([p({type:oe,json:{write:!0}})],d.prototype,"timeExtent",void 0),o([p({type:Number,json:{write:!0}})],d.prototype,"tolerance",void 0),o([p({type:Number,json:{write:!0}})],d.prototype,"width",void 0),d=V=o([F("esri.rest.support.IdentifyParameters")],d);const D=d;let S=class extends Q{constructor(t){super(t),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}readFeature(t,e){return T.fromJSON({attributes:E({},e.attributes),geometry:E({},e.geometry)})}writeFeature(t,e){if(!t)return;const{attributes:r,geometry:s}=t;r&&(e.attributes=E({},r)),O(s)&&(e.geometry=s.toJSON(),e.geometryType=le.toJSON(s.type))}};o([p({type:String,json:{write:!0}})],S.prototype,"displayFieldName",void 0),o([p({type:T})],S.prototype,"feature",void 0),o([ne("feature",["attributes","geometry"])],S.prototype,"readFeature",null),o([pe("feature")],S.prototype,"writeFeature",null),o([p({type:Number,json:{write:!0}})],S.prototype,"layerId",void 0),o([p({type:String,json:{write:!0}})],S.prototype,"layerName",void 0),S=o([F("esri.rest.support.IdentifyResult")],S);const Ce=S;async function Le(t,e,r){const s=(e=Te(e)).geometry?[e.geometry]:[],i=ue(t);return i.path+="/identify",me(s).then(n=>{const m=Ae(e,{geometry:n&&n[0]}),l=ye(E(U(E({},i.query),{f:"json"}),m)),a=de(l,r);return ce(i.path,a).then(Qe).then(c=>De(c,e.sublayers))})}function Qe(t){const e=t.data;e.results=e.results||[];const r={results:[]};return r.results=e.results.map(s=>Ce.fromJSON(s)),r}function Te(t){return t=D.from(t)}function De(t,e){if(!(e==null?void 0:e.length))return t;const r=new Map;function s(i){r.set(i.id,i),i.sublayers&&i.sublayers.forEach(s)}e.forEach(s);for(const i of t.results)i.feature.sourceLayer=r.get(i.layerId);return t}const Be=t=>{let e=class extends t{initialize(){this.exportImageParameters=new Re({layer:this.layer})}destroy(){this.exportImageParameters.destroy(),this.exportImageParameters=null}get exportImageVersion(){var r;return(r=this.exportImageParameters)==null||r.commitProperty("version"),this.commitProperty("timeExtent"),(this._get("exportImageVersion")||0)+1}async fetchPopupFeatures(r,s){var m,l,a,c,y,h;const{layer:i}=this;if(!r)throw new A("mapimagelayer:fetchPopupFeatures","Nothing to fetch without area",{layer:i});const n=(a=(l=(m=this.layer.capabilities)==null?void 0:m.operations)==null?void 0:l.supportsQuery)!=null?a:!0;if(!(((h=(y=(c=this.layer.capabilities)==null?void 0:c.operations)==null?void 0:y.supportsIdentify)!=null?h:!0)&&this.layer.version>=10.5)&&!n)throw new A("mapimagelayer:fetchPopupFeatures-not-supported","query operation is disabled for this service",{layer:i});return n?this._fetchPopupFeaturesUsingQueries(r,s):this._fetchPopupFeaturesUsingIdentify(r,s)}canResume(){var r;return!!super.canResume()&&!((r=this.timeExtent)==null?void 0:r.isEmpty)}async _fetchPopupFeaturesUsingIdentify(r,s){const i=await this._createIdentifyParameters(r,s);if(fe(i))return[];const{results:n}=await Le(this.layer.parsedUrl,i);return n.map(m=>m.feature)}async _createIdentifyParameters(r,s){var P,u;const{floors:i,spatialReference:n,scale:m}=this.view,l=O(s)?s.event:null,a=await this._collectPopupProviders(this.layer.sublayers,m,s);if(!a.length)return null;await Promise.all(a.map(({sublayer:b})=>b.load().catch(()=>{})));const c=Math.min(ge("mapimagelayer-popup-identify-max-tolerance"),this.layer.allSublayers.reduce((b,w)=>w.renderer?J({renderer:w.renderer,event:l}):b,2)),y=this.createFetchPopupFeaturesQueryGeometry(r,c),h=Fe(m,n),g=Math.round(y.width/h),I=new L({xmin:y.center.x-h*g,ymin:y.center.y-h*g,xmax:y.center.x+h*g,ymax:y.center.y+h*g,spatialReference:y.spatialReference}),$=((u=(P=this.layer.capabilities)==null?void 0:P.operations)==null?void 0:u.supportsQuery)===!1||await new Promise(b=>{let w=!1;Promise.all(a.map(async({popupTemplate:f})=>{if(f){const v=await this._loadArcadeModules(f);if(w)return;(v==null?void 0:v.arcadeUtils.hasGeometryOperations(f))&&(w=!0,b(!0))}})).finally(()=>b(!1))});return new D({floors:i,gdbVersion:this.layer.gdbVersion,geometry:r,height:g,layerOption:"popup",mapExtent:I,maxAllowableOffset:$?0:h,returnGeometry:!0,spatialReference:n,sublayers:this.layer.sublayers,timeExtent:this.timeExtent,tolerance:c,width:g})}async _fetchPopupFeaturesUsingQueries(r,s){const i=await this._collectPopupProviders(this.layer.sublayers,this.view.scale,s),n=O(s)?s.event:null,m=i.map(async({sublayer:l,popupTemplate:a})=>{var I,$;await l.load().catch(()=>{});const c=l.createQuery(),y=J({renderer:l.renderer,event:n}),h=this.createFetchPopupFeaturesQueryGeometry(r,y);if(c.geometry=h,c.outFields=await _e(l,a),"floors"in this.view){const P=($=(I=this.view)==null?void 0:I.floors)==null?void 0:$.clone(),u=_(P,l);O(u)&&(c.where=c.where?`(${c.where}) AND (${u})`:u)}const g=await this._loadArcadeModules(a);return g&&g.arcadeUtils.hasGeometryOperations(a)||(c.maxAllowableOffset=h.width/y),(await l.queryFeatures(c)).features});return(await we(m)).reduce((l,a)=>a.value?[...l,...a.value]:l,[]).filter(l=>l!=null)}async _collectPopupProviders(r,s,i){const n=[],m=async a=>{const c=a.minScale===0||s<=a.minScale,y=a.maxScale===0||s>=a.maxScale;if(a.visible&&c&&y){if(a.sublayers)a.sublayers.forEach(m);else if(a.popupEnabled){const h=Me(a,U(E({},i),{defaultPopupTemplateEnabled:!1}));O(h)&&n.unshift({sublayer:a,popupTemplate:h})}}},l=r.toArray().reverse().map(m);return await Promise.all(l),n}_loadArcadeModules(r){var s;if(((s=r.expressionInfos)==null?void 0:s.length)||Array.isArray(r.content)&&r.content.some(i=>i.type==="expression"))return ve()}};return o([p()],e.prototype,"exportImageParameters",void 0),o([p({readOnly:!0})],e.prototype,"exportImageVersion",null),o([p()],e.prototype,"layer",void 0),o([p()],e.prototype,"suspended",void 0),o([p(he)],e.prototype,"timeExtent",void 0),e=o([F("esri.views.layers.MapImageLayerView")],e),e},ke=xe.getLogger("esri.views.2d.layers.MapImageLayerView2D");let j=class extends Be(Ge(Ie(Se))){constructor(){super(...arguments),this._highlightGraphics=new be}update(t){this.strategy.update(t).catch(e=>{$e(e)||ke.error(e)})}attach(){const{imageMaxWidth:t,imageMaxHeight:e,version:r}=this.layer,s=r>=10.3,i=r>=10;this._bitmapContainer=new Pe,this.container.addChild(this._bitmapContainer);const n=new Ee({view:this.view,graphics:this._highlightGraphics,requestUpdateCallback:()=>this.requestUpdate(),container:new Ne(this.view.featuresTilingScheme)});this.container.addChild(n.container),this.strategy=new Oe({container:this._bitmapContainer,fetchSource:this.fetchImage.bind(this),requestUpdate:this.requestUpdate.bind(this),imageMaxWidth:t,imageMaxHeight:e,imageRotationSupported:s,imageNormalizationSupported:i,hidpi:!0}),this.handles.add(q(()=>this.exportImageVersion,()=>this.requestUpdate()),"exportImageVersion"),this.handles.add(q(()=>{var m;return(m=this.view)==null?void 0:m.floors},()=>this.requestUpdate()),"view.floors"),this.requestUpdate()}detach(){this.handles.remove("exportImageVersion"),this.handles.remove("view.floors"),this.strategy.destroy(),this.container.removeAllChildren(),this._bitmapContainer.removeAllChildren()}moveStart(){}viewChange(){}moveEnd(){this.requestUpdate()}highlight(t,e){return this._highlightGraphics.add(t),{remove:()=>{this._highlightGraphics.remove(t)}}}supportsSpatialReference(t){return this.layer.serviceSupportsSpatialReference(t)}createFetchPopupFeaturesQueryGeometry(t,e){return Ue(t,e,this.view)}async doRefresh(){this.requestUpdate()}isUpdating(){return this.strategy.updating||this.updateRequested}fetchImage(t,e,r,s){return this.layer.fetchImage(t,e,r,E({timeExtent:this.timeExtent,floors:this.view.floors},s))}};o([p()],j.prototype,"strategy",void 0),o([p()],j.prototype,"updating",void 0),j=o([F("esri.views.2d.layers.MapImageLayerView2D")],j);const Zt=j;export{Zt as default};
