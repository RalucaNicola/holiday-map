var ze=Object.defineProperty,Re=Object.defineProperties;var He=Object.getOwnPropertyDescriptors;var ge=Object.getOwnPropertySymbols;var Je=Object.prototype.hasOwnProperty,Ye=Object.prototype.propertyIsEnumerable;var de=(e,o,t)=>o in e?ze(e,o,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[o]=t,q=(e,o)=>{for(var t in o||(o={}))Je.call(o,t)&&de(e,t,o[t]);if(ge)for(var t of ge(o))Ye.call(o,t)&&de(e,t,o[t]);return e},V=(e,o)=>Re(e,He(o));import{b6 as Ee,aP as Se,aN as ve,s as se,C as Fe,cv as x,c4 as Te,bf as ce,cw as z,bq as C,r as E,bS as Pe,cx as Ge,cy as We,W as De,cz as Z,cA as Ue,cB as je,bv as Be,br as qe}from"./vendor.c414a8c9.js";import{t as Ve,o as Ke,x as Ze,a as _e,c as be,A as Ne,Z as R,d as j}from"./CIMSymbolHelper.cef2d21f.js";import{H as le,x as ie,D as re,s as Qe}from"./enums.6e42a319.js";import{q as et,C as tt,B as ot,v as it}from"./quantizationUtils.2450b4c7.js";import{b as te,S as rt}from"./Utils.d29fb889.js";import{f as nt}from"./MaterialKey.003e1aef.js";function at(e){var o;if(!e)return null;switch(e.type){case"CIMPointSymbol":{const t=e.symbolLayers;return t&&t.length===1?at(t[0]):null}case"CIMVectorMarker":{const t=e.markerGraphics;if(!t||t.length!==1)return null;const r=t[0];if(!r)return null;const i=r.geometry;if(!i)return null;const n=r.symbol;return!n||n.type!=="CIMPolygonSymbol"&&n.type!=="CIMLineSymbol"||((o=n.symbolLayers)==null?void 0:o.some(l=>!!l.effects))?null:{geom:i,asFill:n.type==="CIMPolygonSymbol"}}case"sdf":return{geom:e.geom,asFill:e.asFill}}return null}function lt(e){return e?e.rings?e.rings:e.paths?e.paths:e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0?[[[e.xmin,e.ymin],[e.xmin,e.ymax],[e.xmax,e.ymax],[e.xmax,e.ymin],[e.xmin,e.ymin]]]:null:null}function st(e){let o=1/0,t=-1/0,r=1/0,i=-1/0;for(const n of e)for(const l of n)l[0]<o&&(o=l[0]),l[0]>t&&(t=l[0]),l[1]<r&&(r=l[1]),l[1]>i&&(i=l[1]);return new Ve(o,r,t-o,i-r)}function Ce(e){let o=1/0,t=-1/0,r=1/0,i=-1/0;for(const n of e)for(const l of n)l[0]<o&&(o=l[0]),l[0]>t&&(t=l[0]),l[1]<r&&(r=l[1]),l[1]>i&&(i=l[1]);return[o,r,t,i]}function we(e){return e?e.rings?Ce(e.rings):e.paths?Ce(e.paths):Ee(e)?[e.xmin,e.ymin,e.xmax,e.ymax]:null:null}function Le(e,o,t,r,i){const[n,l,a,s]=e;if(a<n||s<l)return[0,0,0];const c=a-n,f=s-l,p=128,m=1,u=Math.floor(.5*(.5*p-m)),h=(p-2*(u+m))/Math.max(c,f),y=Math.round(c*h)+2*u,d=Math.round(f*h)+2*u;let S=1;o&&(S=d/h/(o.ymax-o.ymin));let N=0,b=0;if(r)if(i){if(o&&t&&o.ymax-o.ymin>0){const v=(o.xmax-o.xmin)/(o.ymax-o.ymin);N=r.x/(t*v),b=r.y/t}}else N=r.x,b=r.y;return N=.5*(o.xmax+o.xmin)+N*(o.xmax-o.xmin),b=.5*(o.ymax+o.ymin)+b*(o.ymax-o.ymin),N-=n,b-=l,N*=h,b*=h,N+=u,b+=u,[S,N/y-.5,-(b/d-.5)]}function _t(e){const o=lt(e.geom),t=st(o),r=128,i=1,n=Math.floor(.5*(.5*r-i)),l=(r-2*(n+i))/Math.max(t.width,t.height),a=Math.round(t.width*l)+2*n,s=Math.round(t.height*l)+2*n,c=[];for(const p of o)if(p&&p.length>1){const m=[];for(const u of p){let[h,y]=u;h-=t.x,y-=t.y,h*=l,y*=l,h+=n-.5,y+=n-.5,e.asFill?m.push([h,y]):m.push([Math.round(h),Math.round(y)])}if(e.asFill){const u=m.length-1;m[0][0]===m[u][0]&&m[0][1]===m[u][1]||m.push(m[0])}c.push(m)}const f=ct(c,a,s,n);return e.asFill&&ft(c,a,s,n,f),[mt(f,n),a,s]}function ct(e,o,t,r){const i=o*t,n=new Array(i),l=r*r+1;for(let a=0;a<i;++a)n[a]=l;for(const a of e){const s=a.length;for(let c=1;c<s;++c){const f=a[c-1],p=a[c];let m,u,h,y;f[0]<p[0]?(m=f[0],u=p[0]):(m=p[0],u=f[0]),f[1]<p[1]?(h=f[1],y=p[1]):(h=p[1],y=f[1]);let d=Math.floor(m)-r,S=Math.floor(u)+r,N=Math.floor(h)-r,b=Math.floor(y)+r;d<0&&(d=0),S>o&&(S=o),N<0&&(N=0),b>t&&(b=t);const v=p[0]-f[0],k=p[1]-f[1],A=v*v+k*k;for(let P=d;P<S;P++)for(let $=N;$<b;$++){let w,O,M=(P-f[0])*v+($-f[1])*k;M<0?(w=f[0],O=f[1]):M>A?(w=p[0],O=p[1]):(M/=A,w=f[0]+M*v,O=f[1]+M*k);const L=(P-w)*(P-w)+($-O)*($-O),H=(t-$-1)*o+P;L<n[H]&&(n[H]=L)}}}for(let a=0;a<i;++a)n[a]=Math.sqrt(n[a]);return n}function ft(e,o,t,r,i){for(const n of e){const l=n.length;for(let a=1;a<l;++a){const s=n[a-1],c=n[a];let f,p,m,u;s[0]<c[0]?(f=s[0],p=c[0]):(f=c[0],p=s[0]),s[1]<c[1]?(m=s[1],u=c[1]):(m=c[1],u=s[1]);let h=Math.floor(f),y=Math.floor(p)+1,d=Math.floor(m),S=Math.floor(u)+1;h<r&&(h=r),y>o-r&&(y=o-r),d<r&&(d=r),S>t-r&&(S=t-r);for(let N=d;N<S;++N){if(s[1]>N==c[1]>N)continue;const b=(t-N-1)*o;for(let v=h;v<y;++v)v<(c[0]-s[0])*(N-s[1])/(c[1]-s[1])+s[0]&&(i[b+v]=-i[b+v]);for(let v=r;v<h;++v)i[b+v]=-i[b+v]}}}}function mt(e,o){const t=2*o,r=e.length,i=new Uint8Array(4*r);for(let n=0;n<r;++n){const l=.5-e[n]/t;Ke(l,i,4*n)}return i}const ut=96/72;class Oe{static executeEffects(o,t,r){const i=_e(t),n=ut;let l=new be(i);for(const a of o){const s=Ne(a);s&&(l=s.execute(l,a,n,r))}return l}static next(o){const t=o.next();return Ze(t),t}static applyEffects(o,t,r){if(!o)return t;let i=new be(t);for(const a of o){const s=Ne(a);s&&(i=s.execute(i,a,1,r))}let n,l=null;for(;n=i.next();)l?Se(l)?Se(n)&&l.paths.push(...n.paths):ve(l)&&ve(n)&&l.rings.push(...n.rings):l=n;return l}}function _(e,o,t,r,i){const n=e.referencesGeometry()&&i?pt(o,r,i):o,l=e.repurposeFeature(n);try{return e.evaluate(V(q({},t),{$feature:l}))}catch(a){return se.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const ne=new Map;function pt(e,o,t){const{transform:r,hasZ:i,hasM:n}=t;ne.has(o)||ne.set(o,yt(o));const l=ne.get(o)(e.geometry,r,i,n);return V(q({},e),{geometry:l})}function yt(e){const o={};switch(e){case"esriGeometryPoint":return(t,r,i,n)=>it(r,o,t,i,n);case"esriGeometryPolygon":return(t,r,i,n)=>ot(r,o,t,i,n);case"esriGeometryPolyline":return(t,r,i,n)=>tt(r,o,t,i,n);case"esriGeometryMultipoint":return(t,r,i,n)=>et(r,o,t,i,n);default:return se.getLogger("esri.views.2d.support.arcadeOnDemand").error(new Fe("mapview-arcade",`Unable to handle geometryType: ${e}`)),t=>t}}function $e(e){const o=e.toLowerCase().split(" ").join("-");switch(o){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return o}}function Qt(e){const o=ht(e)+gt(e);return $e(e.family)+(o.length>0?o:"-regular")}function ht(e){if(!e.weight)return"";switch(e.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function gt(e){if(!e.style)return"";switch(e.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}function dt(e,o){let t;if(typeof e=="string")t=x(e+`-seed(${o})`);else{let r=12;t=e^o;do t=107*(t>>8^t)+r|0;while(--r!=0)}return(1+t/(1<<31))/2}function St(e){return Math.floor(dt(e,vt)*bt)}const vt=53290320,bt=10,fe=se.getLogger("esri.symbols.cim.cimAnalyzer");function me(e){switch(e){case"Butt":return ie.BUTT;case"Square":return ie.SQUARE;default:return ie.ROUND}}function ue(e){switch(e){case"Bevel":return re.BEVEL;case"Miter":return re.MITER;default:return re.ROUND}}function Nt(e){switch(e){case"Left":default:return"left";case"Right":return"right";case"Center":return"center";case"Justify":return fe.warnOnce("Horizontal alignment 'justify' is not implemented. Falling back to 'center'."),"center"}}function Ct(e){switch(e){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function Ot(e){let o="",t="";if(e){const r=e.toLowerCase();r.includes("italic")?o="italic":r.includes("oblique")&&(o="oblique"),r.includes("bold")?t="bold":r.includes("light")&&(t="lighter")}return{style:o,weight:t}}function kt(e){return e.underline?"underline":e.strikethrough?"line-through":"none"}function ke(e,o,t,r){let i;e[o]?i=e[o]:(i={},e[o]=i),i[t]=r}function Me(e){const o=e.markerPlacement;return o&&o.angleToLine?le.MAP:le.SCREEN}async function eo(e,o,t,r,i){const n=r!=null?r:[];if(!e)return n;let l,a;const s={};if(e.type!=="CIMSymbolReference")return fe.error("Expect cim type to be 'CIMSymbolReference'"),n;if(l=e.symbol,a=e.primitiveOverrides,a){const f=[];for(const p of a){const m=p.valueExpressionInfo;if(m&&o){const u=m.expression,h=Te(u,o.spatialReference,o.fields).then(y=>{y&&ke(s,p.primitiveName,p.propertyName,y)});f.push(h)}else p.value!=null&&ke(s,p.primitiveName,p.propertyName,p.value)}f.length>0&&await Promise.all(f)}const c=[];switch(Ae(l,t,c),c.length>0&&await Promise.all(c),l.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Mt(l,a,s,o,n,t,i)}return n}function Mt(e,o,t,r,i,n,l){if(!e)return;const a=e.symbolLayers;if(!a)return;const s=e.effects;let c;const f=R.getSize(e);e.type==="CIMPointSymbol"&&e.angleAlignment==="Map"&&(c=le.MAP);let p=a.length;for(;p--;){const m=a[p];if(!m||m.enable===!1)continue;let u;s&&s.length&&(u=[...s]);const h=m.effects;h&&h.length&&(s?u.push(...h):u=[...h]);const y=[];let d;j.findEffectOverrides(u,o,y),d=y.length>0?Et(u,y,t,r):u;const S=[];switch(j.findApplicableOverrides(m,o,S),m.type){case"CIMSolidFill":xt(m,d,t,S,r,i);break;case"CIMPictureFill":Pt(m,d,t,S,r,n,i);break;case"CIMHatchFill":wt(m,d,t,S,r,i);break;case"CIMGradientFill":Lt(m,d,t,S,r,i);break;case"CIMSolidStroke":$t(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMPictureStroke":It(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMGradientStroke":At(m,d,t,S,r,i,e.type==="CIMPolygonSymbol",f);break;case"CIMCharacterMarker":if(ae(m,d,t,S,r,i))break;break;case"CIMPictureMarker":if(ae(m,d,t,S,r,i))break;e.type==="CIMLineSymbol"&&(c=Me(m)),Xt(m,d,t,S,r,n,i,c,f);break;case"CIMVectorMarker":if(ae(m,d,t,S,r,i))break;e.type==="CIMLineSymbol"&&(c=Me(m)),zt(m,d,t,S,r,i,n,c,f,l);break;default:fe.error("Cannot analyze CIM layer",m.type)}}}function xt(e,o,t,r,i,n){const l=e.primitiveName,a=z(e.color),[s,c]=Y(r,l,o,null,null),f=x(JSON.stringify(e)+c).toString();n.push({type:"fill",templateHash:f,materialHash:s?()=>f:f,cim:e,materialOverrides:null,colorLocked:e.colorLocked,color:g(l,t,"Color",i,a,J),height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,effects:o,applyRandomOffset:!1,sampleAlphaOnly:!0})}function Pt(e,o,t,r,i,n,l){const a=e.primitiveName,s=e.tintColor?z(e.tintColor):{r:255,g:255,b:255,a:1},[c,f]=Y(r,a,o,null,null),p=x(JSON.stringify(e)+f).toString(),m=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString();let u=C(e.scaleX);if("width"in e){const h=e.width;let y=1;const d=n.getResource(e.url);E(d)&&(y=d.width/d.height),u/=y*(e.height/h)}l.push({type:"fill",templateHash:p,materialHash:c?()=>m:m,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,color:g(a,t,"TintColor",i,s,J),height:g(a,t,"Height",i,e.height),scaleX:g(a,t,"ScaleX",i,u),angle:g(a,t,"Rotation",i,C(e.rotation)),offsetX:g(a,t,"OffsetX",i,C(e.offsetX)),offsetY:g(a,t,"OffsetY",i,C(e.offsetY)),url:e.url,applyRandomOffset:!1,sampleAlphaOnly:!1})}function wt(e,o,t,r,i,n){var h;const l=["Rotation","OffsetX","OffsetY"],a=r.filter(y=>y.primitiveName!==e.primitiveName&&!l.includes(y.propertyName)),s=e.primitiveName,[c,f]=Y(r,s,o,null,null),p=x(JSON.stringify(e)+f).toString(),m=x(`${e.separation}${JSON.stringify(e.lineSymbol)}`).toString();let u={r:255,g:255,b:255,a:1};if(e.lineSymbol){const y=(h=e.lineSymbol)==null?void 0:h.symbolLayers.find(d=>d.type==="CIMSolidStroke");y&&(u=z(y.color))}n.push({type:"fill",templateHash:p,materialHash:c?Q(m,t,a,i):m,cim:e,materialOverrides:a,colorLocked:e.colorLocked,effects:o,color:u,height:g(s,t,"Separation",i,e.separation),scaleX:1,angle:g(s,t,"Rotation",i,C(e.rotation)),offsetX:g(s,t,"OffsetX",i,C(e.offsetX)),offsetY:g(s,t,"OffsetY",i,C(e.offsetY)),applyRandomOffset:!1,sampleAlphaOnly:!0})}function Lt(e,o,t,r,i,n){const l=e.primitiveName,[a,s]=Y(r,l,o,null,null),c=x(JSON.stringify(e)+s).toString();n.push({type:"fill",templateHash:c,materialHash:a?Q(c,t,r,i):c,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,color:{r:128,g:128,b:128,a:1},height:0,angle:0,offsetX:0,offsetY:0,scaleX:1,applyRandomOffset:!1,sampleAlphaOnly:!1})}function $t(e,o,t,r,i,n,l,a){const s=e.primitiveName,c=z(e.color),f=e.width!==void 0?e.width:4,p=me(e.capStyle),m=ue(e.joinStyle),u=e.miterLimit,[h,y]=Y(r,s,o,null,null),d=x(JSON.stringify(e)+y).toString();let S,N;if(o&&o instanceof Array&&o.length>0){const b=o[o.length-1];if(b.type==="CIMGeometricEffectDashes"&&b.lineDashEnding==="NoConstraint"&&b.offsetAlongLine===null){const v=(o=[...o]).pop();S=v.dashTemplate,N=v.scaleDash}}n.push({type:"line",templateHash:d,materialHash:h?()=>d:d,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:g(s,t,"Color",i,c,J),width:g(s,t,"Width",i,f),cap:g(s,t,"CapStyle",i,p),join:g(s,t,"JoinStyle",i,m),miterLimit:g(s,t,"MiterLimit",i,u),referenceWidth:a,zOrder:pe(e.name),dashTemplate:S,scaleDash:N,sampleAlphaOnly:!0})}function It(e,o,t,r,i,n,l,a){const s=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}`).toString(),c=e.primitiveName,f=z(e.tintColor),p=e.width!==void 0?e.width:4,m=me(e.capStyle),u=ue(e.joinStyle),h=e.miterLimit,[y,d]=Y(r,c,o,null,null),S=x(JSON.stringify(e)+d).toString();n.push({type:"line",templateHash:S,materialHash:y?()=>s:s,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:g(c,t,"TintColor",i,f,J),width:g(c,t,"Width",i,p),cap:g(c,t,"CapStyle",i,m),join:g(c,t,"JoinStyle",i,u),miterLimit:g(c,t,"MiterLimit",i,h),referenceWidth:a,zOrder:pe(e.name),dashTemplate:null,scaleDash:!1,url:e.url,sampleAlphaOnly:!1})}function At(e,o,t,r,i,n,l,a){const s=e.primitiveName,c=e.width!==void 0?e.width:4,f=me(e.capStyle),p=ue(e.joinStyle),m=e.miterLimit,[u,h]=Y(r,s,o,null,null),y=x(JSON.stringify(e)+h).toString();n.push({type:"line",templateHash:y,materialHash:u?Q(y,t,r,i):y,cim:e,materialOverrides:null,isOutline:l,colorLocked:e.colorLocked,effects:o,color:{r:128,g:128,b:128,a:1},width:g(s,t,"Width",i,c),cap:g(s,t,"CapStyle",i,f),join:g(s,t,"JoinStyle",i,p),miterLimit:g(s,t,"MiterLimit",i,m),referenceWidth:a,zOrder:pe(e.name),dashTemplate:null,scaleDash:!1,sampleAlphaOnly:!1})}function ae(e,o,t,r,i,n){const l=e.markerPlacement;if(!l||l.type!=="CIMMarkerPlacementInsidePolygon")return!1;const a=l,s=Math.abs(a.stepX),c=Math.abs(a.stepY);if(s===0||c===0)return!0;const f=["Rotation","OffsetX","OffsetY"],p=r.filter(v=>v.primitiveName!==e.primitiveName&&!f.includes(v.propertyName)),m="url"in e?e.url:null,[u,h]=Y(r,a.primitiveName,o,null,null),y=x(JSON.stringify(e)+h).toString();let d,S,N=null;if(l.gridType==="Random"){const v=qe(Qe),k=Math.max(Math.floor(v/s),1),A=Math.max(Math.floor(v/c),1);d=c*A,N=P=>P?P*A:0,S=k*s/d}else l.shiftOddRows?(d=2*c,N=v=>v?2*v:0,S=s/c*.5):(d=c,N=null,S=s/c);let b={r:255,g:255,b:255,a:1};return"tintColor"in e&&(b=z(e.tintColor)),n.push({type:"fill",templateHash:y,materialHash:u?Q(y,t,p,i):y,cim:e,materialOverrides:p,colorLocked:e.colorLocked,effects:o,color:g(a.primitiveName,t,"TintColor",i,b,J),height:g(a.primitiveName,t,"StepY",i,d,N),scaleX:S,angle:g(a.primitiveName,t,"GridAngle",i,a.gridAngle),offsetX:g(a.primitiveName,t,"OffsetX",i,C(a.offsetX)),offsetY:g(a.primitiveName,t,"OffsetY",i,C(a.offsetY)),url:m,applyRandomOffset:l.gridType==="Random",sampleAlphaOnly:!m}),!0}function Xt(e,o,t,r,i,n,l,a,s){var w;const c=e.primitiveName,f=C(e.size);let p=C(e.scaleX);const m=C(e.rotation),u=C(e.offsetX),h=C(e.offsetY),y=e.tintColor?z(e.tintColor):{r:255,g:255,b:255,a:1},d=x(`${e.url}${JSON.stringify(e.colorSubstitutions)}${JSON.stringify(e.animatedSymbolProperties)}`).toString(),S=Ie(e.markerPlacement,r,t,i),N=Ft(e.animatedSymbolProperties,r,t,i),[b,v]=Y(r,c,o,S,N),k=x(JSON.stringify(e)+v).toString(),A=(w=e.anchorPoint)!=null?w:{x:0,y:0};if("width"in e){const O=e.width;let M=1;const L=n.getResource(e.url);E(L)&&(M=L.width/L.height),p/=M*(f/O)}function P(O,M){return Pe(N,O,M)}const $=e.animatedSymbolProperties&&e.animatedSymbolProperties.randomizeStartTime===!0?(O,M,L,H)=>{const F=St(H),T=P(O,M);return d+`-MATERIALGROUP(${F})-ASP(${JSON.stringify(T)})`}:b?(O,M)=>{const L=P(O,M);return d+`-ASP(${JSON.stringify(L)})`}:d;l.push({type:"marker",templateHash:k,materialHash:$,cim:e,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:!1,alignment:a,size:g(c,t,"Size",i,f),scaleX:g(c,t,"ScaleX",i,p),rotation:g(c,t,"Rotation",i,m),offsetX:g(c,t,"OffsetX",i,u),offsetY:g(c,t,"OffsetY",i,h),color:g(c,t,"TintColor",i,y,J),anchorPoint:{x:A.x,y:-A.y},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,frameHeight:0,rotateClockwise:e.rotateClockwise,referenceSize:s,sizeRatio:1,markerPlacement:S,url:e.url,animatedSymbolProperties:N})}function zt(e,o,t,r,i,n,l,a,s,c){const f=e.markerGraphics;if(!f)return;let p=0;if(e.scaleSymbolsProportionally){const u=e.frame;u&&(p=u.ymax-u.ymin)}const m=Ie(e.markerPlacement,r,t,i);for(const u of f)if(u){const h=u.symbol;if(!h)continue;switch(h.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":Ht(e,o,m,null,u,r,t,i,n,l,a,s,p,c);break;case"CIMTextSymbol":Rt(e,o,m,u,t,r,i,n,a,s,p)}}}function Rt(e,o,t,r,i,n,l,a,s,c,f){const p=[];j.findApplicableOverrides(r,n,p);const m=r.geometry;if(!("x"in m)||!("y"in m))return;const u=r.symbol,h=kt(u),y=Ot(u.fontStyleName),d=$e(u.fontFamilyName);u.font=q({family:d,decoration:h},y);const S=e.frame,N=m.x-.5*(S.xmin+S.xmax),b=m.y-.5*(S.ymin+S.ymax),v=e.size/f,k=e.primitiveName,A=C(u.height)*v,P=C(u.angle),$=C(e.offsetX)+(C(u.offsetX)+N)*v,w=C(e.offsetY)+(C(u.offsetY)+b)*v,O=z(R.getFillColor(u));let M=z(R.getStrokeColor(u)),L=R.getStrokeWidth(u);L||(M=z(R.getFillColor(u.haloSymbol)),L=u.haloSize*v);const[H,F]=Y(n,k,o,t,null),T=JSON.stringify(e.effects)+Number(e.colorLocked)+JSON.stringify(e.anchorPoint)+e.anchorPointUnits+JSON.stringify(e.markerPlacement),G=x(JSON.stringify(r)+T+F).toString();let I=g(r.primitiveName,i,"TextString",l,r.textString,Ge,u.textCase);if(I==null)return;const{fontStyleName:B}=u,W=d+(B?"-"+B.toLowerCase():"-regular"),D=W;typeof I=="string"&&I.includes("[")&&u.fieldMap&&(I=We(u.fieldMap,I,u.textCase)),a.push({type:"text",templateHash:G,materialHash:H||typeof I=="function"||I.match(/\[(.*?)\]/)?(X,ee,oe)=>D+"-"+Pe(I,X,ee,oe):D+"-"+x(I),cim:u,materialOverrides:null,colorLocked:e.colorLocked,effects:o,alignment:s,anchorPoint:{x:e.anchorPoint?e.anchorPoint.x:0,y:e.anchorPoint?e.anchorPoint.y:0},isAbsoluteAnchorPoint:e.anchorPointUnits!=="Relative",fontName:W,decoration:h,weight:g(k,i,"Weight",l,y.weight),style:g(k,i,"Size",l,y.style),size:g(k,i,"Size",l,A),angle:g(k,i,"Rotation",l,P),offsetX:g(k,i,"OffsetX",l,$),offsetY:g(k,i,"OffsetY",l,w),horizontalAlignment:Nt(u.horizontalAlignment),verticalAlignment:Ct(u.verticalAlignment),text:I,color:O,outlineColor:M,outlineSize:L,referenceSize:c,sizeRatio:1,markerPlacement:t})}function Ht(e,o,t,r,i,n,l,a,s,c,f,p,m,u){var N;const h=i.symbol,y=h.symbolLayers;if(!y)return;if(u)return void xe(e,o,t,r,i,l,n,a,s,c,f,p,m);let d=y.length;if(Tt(y))return void Jt(e,o,t,r,i,y,n,l,a,s,f,p,m);const S=Oe.applyEffects(h.effects,i.geometry,c.geometryEngine);if(S)for(;d--;){const b=y[d];if(b&&b.enable!==!1)switch(b.type){case"CIMSolidFill":case"CIMSolidStroke":{const v=Oe.applyEffects(b.effects,S,c.geometryEngine),k=we(v);if(!k)continue;const[A,P,$]=Le(k,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),w=b.type==="CIMSolidFill",O={type:"sdf",geom:v,asFill:w},M=e.primitiveName,L=(N=C(e.size))!=null?N:10,H=C(e.rotation),F=C(e.offsetX),T=C(e.offsetY),G=b.path,I=b.primitiveName,B=z(w?R.getFillColor(b):R.getStrokeColor(b)),W=w?{r:0,g:0,b:0,a:0}:z(R.getStrokeColor(b)),D=R.getStrokeWidth(b);if(!w&&!D)break;let X=!1,ee="";for(const U of n)U.primitiveName!==I&&U.primitiveName!==M||(U.value!==void 0?ee+=`-${U.primitiveName}-${U.propertyName}-${JSON.stringify(U.value)}`:U.valueExpressionInfo&&(X=!0));E(o)&&typeof o=="function"&&(X=!0);const oe=JSON.stringify(V(q({},e),{markerGraphics:null})),he=x(JSON.stringify(O)+G).toString(),Xe={type:"marker",templateHash:x(JSON.stringify(i)+JSON.stringify(b)+oe+ee).toString(),materialHash:X?()=>he:he,cim:O,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:P,y:$},isAbsoluteAnchorPoint:!1,size:g(e.primitiveName,l,"Size",a,L),rotation:g(e.primitiveName,l,"Rotation",a,H),offsetX:g(e.primitiveName,l,"OffsetX",a,F),offsetY:g(e.primitiveName,l,"OffsetY",a,T),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:A,color:g(I,l,"Color",a,B,J),outlineColor:g(I,l,"Color",a,W,J),outlineWidth:g(I,l,"Width",a,D),markerPlacement:t,animatedSymbolProperties:r,path:G};s.push(Xe);break}default:xe(e,o,t,r,i,l,n,a,s,c,f,p,m)}}}function Jt(e,o,t,r,i,n,l,a,s,c,f,p,m){const u=i.geometry,h=n[0],y=n[1],d=we(u);if(!d)return;const[S,N,b]=Le(d,e.frame,e.size,e.anchorPoint,e.anchorPointUnits!=="Relative"),v={type:"sdf",geom:u,asFill:!0},k=e.primitiveName,A=C(e.size),P=C(e.rotation),$=C(e.offsetX),w=C(e.offsetY),O=y.path,M=y.primitiveName,L=h.primitiveName,H=z(R.getFillColor(y)),F=z(R.getStrokeColor(h)),T=R.getStrokeWidth(h);let G=!1,I="";for(const X of l)X.primitiveName!==M&&X.primitiveName!==L&&X.primitiveName!==k||(X.value!==void 0?I+=`-${X.primitiveName}-${X.propertyName}-${JSON.stringify(X.value)}`:X.valueExpressionInfo&&(G=!0));const B=JSON.stringify(V(q({},e),{markerGraphics:null})),W=x(JSON.stringify(v)+O).toString(),D={type:"marker",templateHash:x(JSON.stringify(i)+JSON.stringify(y)+JSON.stringify(h)+B+I).toString(),materialHash:G?()=>W:W,cim:v,materialOverrides:null,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:N,y:b},isAbsoluteAnchorPoint:!1,size:g(e.primitiveName,a,"Size",s,A),rotation:g(e.primitiveName,a,"Rotation",s,P),offsetX:g(e.primitiveName,a,"OffsetX",s,$),offsetY:g(e.primitiveName,a,"OffsetY",s,w),scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:S,color:g(M,a,"Color",s,H,J),outlineColor:g(L,a,"Color",s,F,J),outlineWidth:g(L,a,"Width",s,T),markerPlacement:t,path:O,animatedSymbolProperties:r};c.push(D)}function xe(e,o,t,r,i,n,l,a,s,c,f,p,m){const u=Yt(e,i);let h=[];const y=["Rotation","OffsetX","OffsetY"];h=l.filter(O=>O.primitiveName!==e.primitiveName||!y.includes(O.propertyName));let d="";for(const O of l)O.value!==void 0&&(d+=`-${O.primitiveName}-${O.propertyName}-${JSON.stringify(O.value)}`);const[S,N,b]=R.getTextureAnchor(u,c),v=e.primitiveName,k=C(e.rotation),A=C(e.offsetX),P=C(e.offsetY),$=x(JSON.stringify(u)+d).toString(),w={type:"marker",templateHash:$,materialHash:h.length>0||E(o)&&typeof o=="function"?Q($,n,h,a):$,cim:u,materialOverrides:h,colorLocked:e.colorLocked,effects:o,scaleSymbolsProportionally:e.scaleSymbolsProportionally,alignment:f,anchorPoint:{x:S,y:N},isAbsoluteAnchorPoint:!1,size:e.size,rotation:g(v,n,"Rotation",a,k),offsetX:g(v,n,"OffsetX",a,A),offsetY:g(v,n,"OffsetY",a,P),color:{r:255,g:255,b:255,a:1},outlineColor:{r:0,g:0,b:0,a:0},outlineWidth:0,scaleX:1,frameHeight:m,rotateClockwise:e.rotateClockwise,referenceSize:p,sizeRatio:b/De(e.size),markerPlacement:t,animatedSymbolProperties:r};s.push(w)}function Yt(e,o){return{type:e.type,enable:!0,name:e.name,colorLocked:e.colorLocked,primitiveName:e.primitiveName,anchorPoint:e.anchorPoint,anchorPointUnits:e.anchorPointUnits,offsetX:0,offsetY:0,rotateClockwise:e.rotateClockwise,rotation:0,size:e.size,billboardMode3D:e.billboardMode3D,depth3D:e.depth3D,frame:e.frame,markerGraphics:[o],scaleSymbolsProportionally:e.scaleSymbolsProportionally,respectFrame:e.respectFrame,clippingPath:e.clippingPath}}function pe(e){if(e&&e.indexOf("Level_")===0){const o=parseInt(e.substr(6),10);if(!isNaN(o))return o}return 0}function J(e){if(!e||e.length===0)return null;const o=new Be(e).toRgba();return{r:o[0],g:o[1],b:o[2],a:o[3]}}function g(e,o,t,r,i,n,l){const a=o[e];if(a){const s=a[t];if(typeof s=="string"||typeof s=="number"||s instanceof Array)return n?n.call(null,s,l):s;if(s!=null&&s instanceof Z)return(c,f,p)=>{let m=_(s,c,{$view:p},r.geometryType,f);return m!==null&&n&&(m=n.call(null,m,l)),m!==null?m:i}}return i}function ye(e){return e&&e.charAt(0).toLowerCase()+e.substr(1)}function Et(e,o,t,r){for(const i of o)if(i.valueExpressionInfo){const n=t[i.primitiveName]&&t[i.primitiveName][i.propertyName];n instanceof Z&&(i.fn=(l,a,s)=>_(n,l,{$view:s},r.geometryType,a))}return(i,n,l)=>{for(const s of o)s.fn&&(s.value=s.fn(i,n,l));const a=[];for(let s of e){const c=s==null?void 0:s.primitiveName;if(c){let f=!1;for(const p of o)if(p.primitiveName===c){const m=ye(p.propertyName);p.value!=null&&p.value!==s[m]&&(f||(s=ce(s),f=!0),s[m]=p.value)}}a.push(s)}return a}}function Ie(e,o,t,r){const i=[];if(j.findApplicableOverrides(e,o,i),i.length===0)return e;for(const n of i)if(n.valueExpressionInfo){const l=t[n.primitiveName]&&t[n.primitiveName][n.propertyName];l instanceof Z&&(n.fn=(a,s,c)=>_(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of i)f.fn&&(f.value=f.fn(n,l,a));const s=ce(e),c=e.primitiveName;for(const f of i)if(f.primitiveName===c){const p=ye(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function Ft(e,o,t,r){const i=[];if(j.findApplicableOverrides(e,o,i),i.length===0)return e;for(const n of i)if(n.valueExpressionInfo){const l=t[n.primitiveName]&&t[n.primitiveName][n.propertyName];l instanceof Z&&(n.fn=(a,s,c)=>_(l,a,{$view:c},r.geometryType,s))}return(n,l,a)=>{for(const f of i)f.fn&&(f.value=f.fn(n,l,a));const s=ce(e),c=e.primitiveName;for(const f of i)if(f.primitiveName===c){const p=ye(f.propertyName);f.value!=null&&f.value!==s[p]&&(s[p]=f.value)}return s}}function Q(e,o,t,r){for(const i of t)if(i.valueExpressionInfo){const n=o[i.primitiveName]&&o[i.primitiveName][i.propertyName];n instanceof Z&&(i.fn=(l,a,s)=>_(n,l,{$view:s},r.geometryType,a))}return(i,n,l)=>{for(const a of t)a.fn&&(a.value=a.fn(i,n,l));return x(e+j.buildOverrideKey(t)).toString()}}function to(e,o){if(!o||o.length===0)return e;const t=JSON.parse(JSON.stringify(e));return j.applyOverrides(t,o),t}function Y(e,o,t,r,i){let n=!1,l="";for(const a of e)a.primitiveName===o&&(a.value!==void 0?l+=`-${a.primitiveName}-${a.propertyName}-${JSON.stringify(a.value)}`:a.valueExpressionInfo&&(n=!0));return E(t)&&typeof t=="function"&&(n=!0),E(r)&&typeof r=="function"&&(n=!0),E(i)&&typeof i=="function"&&(n=!0),[n,l]}function Ae(e,o,t){if(e&&o)switch(e.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":{const r=e.symbolLayers;if(!r)return;for(const i of r)switch(Gt(i,o,t),i.type){case"CIMPictureFill":case"CIMHatchFill":case"CIMGradientFill":case"CIMPictureStroke":case"CIMGradientStroke":case"CIMCharacterMarker":case"CIMPictureMarker":"url"in i&&i.url&&t.push(o.fetchResource(i.url,null));break;case"CIMVectorMarker":{const n=i.markerGraphics;if(!n)continue;for(const l of n)if(l){const a=l.symbol;a&&Ae(a,o,t)}}}}}}const Tt=e=>e&&e.length===2&&e[0].enable&&e[1].enable&&e[0].type==="CIMSolidStroke"&&e[1].type==="CIMSolidFill"&&!e[0].effects&&!e[1].effects;let K;function Gt(e,o,t){if(!(!e.effects||E(o.geometryEngine))){if(K)return void t.push(K);Ue(e.effects)&&(K=je(),t.push(K),K.then(r=>o.geometryEngine=r))}}const Wt={marker:te.MARKER,fill:te.FILL,line:te.LINE,text:te.TEXT};class oo{constructor(o,t,r,i){const n={minScale:t==null?void 0:t.minScale,maxScale:t==null?void 0:t.maxScale},l=Dt(n);this.layers=o,this.data=t,this.hash=this._createHash()+l,this.rendererKey=r;const a={isOutline:!1,placement:null,symbologyType:rt.DEFAULT,vvFlags:r};for(const s of o){const c=Wt[s.type];a.isOutline=s.type==="line"&&s.isOutline,s.materialKey=nt(c,a),s.maxVVSize=i,s.scaleInfo=n,s.templateHash+=l}}get type(){return"expanded-cim"}_createHash(){let o="";for(const t of this.layers)o+=t.templateHash;return o}}function Dt(e){return e.minScale||e.maxScale?e.minScale+"-"+e.maxScale:""}export{eo as Y,_t as a,_ as b,dt as e,Oe as f,oo as l,Qt as n,St as o,at as r,to as s};
